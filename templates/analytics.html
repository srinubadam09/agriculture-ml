<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Analytics - Smart Farm Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }

body {
    font-family: 'Inter', sans-serif;
    background: linear-gradient(135deg, #f5f7fa 0%, #e8eef3 100%);
    color: #2b2d42;
    overflow-x: hidden;
}

.navbar {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    padding: 1rem 2rem;
    box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    display: flex;
    justify-content: space-between;
    align-items: center;
    position: sticky;
    top: 0;
    z-index: 1000;
    animation: slideDown 0.5s ease-out;
}

@keyframes slideDown {
    from { transform: translateY(-100%); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
}

.brand {
    font-weight: 700;
    color: #2d6a4f;
    text-decoration: none;
    font-size: 1.5rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    transition: transform 0.3s ease;
}

.brand:hover { transform: scale(1.05); }

.nav-links {
    display: flex;
    gap: 2rem;
    list-style: none;
}

.nav-links a {
    text-decoration: none;
    color: #2b2d42;
    font-weight: 500;
    position: relative;
    transition: color 0.3s ease;
}

.nav-links a::after {
    content: '';
    position: absolute;
    left: 0;
    bottom: -5px;
    width: 0;
    height: 2px;
    background: #52b788;
    transition: width 0.3s ease;
}

.nav-links a:hover::after,
.nav-links a.active::after {
    width: 100%;
}

.page-header {
    background: linear-gradient(135deg, #2d6a4f 0%, #52b788 100%);
    color: #fff;
    padding: 4rem 2rem;
    text-align: center;
    position: relative;
    overflow: hidden;
}

.page-header::before {
    content: '';
    position: absolute;
    top: -50%;
    right: -10%;
    width: 500px;
    height: 500px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 50%;
    animation: float 6s ease-in-out infinite;
}

.page-header::after {
    content: '';
    position: absolute;
    bottom: -30%;
    left: -5%;
    width: 400px;
    height: 400px;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 50%;
    animation: float 8s ease-in-out infinite;
}

@keyframes float {
    0%, 100% { transform: translateY(0) rotate(0deg); }
    50% { transform: translateY(-20px) rotate(180deg); }
}

.page-header h1 {
    font-size: 3rem;
    margin-bottom: 0.5rem;
    position: relative;
    z-index: 1;
    animation: fadeInUp 0.8s ease-out;
}

.page-header p {
    opacity: 0.95;
    font-size: 1.1rem;
    position: relative;
    z-index: 1;
    animation: fadeInUp 1s ease-out;
}

@keyframes fadeInUp {
    from { transform: translateY(30px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
}

.container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 3rem 2rem;
}

.metrics-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 1.5rem;
    margin-bottom: 3rem;
}

.metric-card {
    background: #fff;
    padding: 2rem;
    border-radius: 20px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.08);
    display: flex;
    align-items: center;
    gap: 1.5rem;
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: hidden;
    animation: fadeInScale 0.6s ease-out backwards;
}

.metric-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(135deg, transparent 0%, rgba(82, 183, 136, 0.05) 100%);
    opacity: 0;
    transition: opacity 0.4s ease;
    z-index: 1; /* Make sure this is behind the content */
    pointer-events: none; /* This allows clicks to pass through */
}

.metric-card:hover {
    transform: translateY(-10px) scale(1.02);
    box-shadow: 0 20px 40px rgba(0,0,0,0.12);
}

.metric-card:hover::before {
    opacity: 1;
}

@keyframes fadeInScale {
    from { transform: scale(0.9); opacity: 0; }
    to { transform: scale(1); opacity: 1; }
}

.metric-card:nth-child(1) { animation-delay: 0.1s; }
.metric-card:nth-child(2) { animation-delay: 0.2s; }
.metric-card:nth-child(3) { animation-delay: 0.3s; }
.metric-card:nth-child(4) { animation-delay: 0.4s; }
.metric-card:nth-child(5) { animation-delay: 0.5s; }
.metric-card:nth-child(6) { animation-delay: 0.6s; }

.metric-icon {
    width: 70px;
    height: 70px;
    border-radius: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 2rem;
    position: relative;
    transition: transform 0.4s ease;
    z-index: 2; /* Ensure icon is above the pseudo-element */
}

.metric-card:hover .metric-icon {
    transform: rotate(10deg) scale(1.1);
}

.metric-icon.green {
    background: linear-gradient(135deg, rgba(82,183,136,0.2) 0%, rgba(82,183,136,0.05) 100%);
    color: #52b788;
}

.metric-icon.blue {
    background: linear-gradient(135deg, rgba(52,152,219,0.2) 0%, rgba(52,152,219,0.05) 100%);
    color: #3498db;
}

.metric-icon.orange {
    background: linear-gradient(135deg, rgba(244,162,97,0.2) 0%, rgba(244,162,97,0.05) 100%);
    color: #f4a261;
}

.metric-icon.red {
    background: linear-gradient(135deg, rgba(231,111,81,0.2) 0%, rgba(231,111,81,0.05) 100%);
    color: #e76f51;
}

.metric-info { 
    flex: 1; 
    position: relative; /* Ensure content is above pseudo-element */
    z-index: 2;
}

.metric-info h3 {
    font-size: 2.2rem;
    font-weight: 700;
    margin-bottom: 0.3rem;
    background: linear-gradient(135deg, #2b2d42 0%, #52b788 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.metric-info p {
    font-size: 0.95rem;
    color: #6c757d;
    font-weight: 500;
}

button {
    cursor: pointer;
    padding: 0.7rem 1.5rem;
    border: none;
    border-radius: 10px;
    color: white;
    background: linear-gradient(135deg, #52b788 0%, #2d6a4f 100%);
    font-weight: 600;
    font-size: 0.9rem;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(82, 183, 136, 0.3);
    margin-top: 0.5rem;
    position: relative; /* Ensure button is above pseudo-element */
    z-index: 3;
}

button:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(82, 183, 136, 0.4);
}

button:active {
    transform: translateY(0);
}

button:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none !important;
    box-shadow: 0 4px 15px rgba(82, 183, 136, 0.2) !important;
}

.chart-container {
    background: #fff;
    padding: 2rem;
    border-radius: 20px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.08);
    margin-bottom: 2rem;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    animation: fadeInUp 0.8s ease-out backwards;
}

.chart-container:nth-of-type(7) { animation-delay: 0.2s; }
.chart-container:nth-of-type(8) { animation-delay: 0.4s; }
.chart-container:nth-of-type(9) { animation-delay: 0.6s; }

.chart-container:hover {
    transform: translateY(-5px);
    box-shadow: 0 15px 40px rgba(0,0,0,0.12);
}

.chart-header {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
    border-bottom: 2px solid #f5f7fa;
}

.chart-header i {
    font-size: 1.5rem;
    color: #52b788;
}

.chart-header h3 {
    font-size: 1.3rem;
    font-weight: 600;
    color: #2b2d42;
}

#servoStatus {
    font-size: 0.85rem;
    margin-top: 0.5rem;
    font-weight: 500;
    min-height: 20px;
    position: relative;
    z-index: 2;
}

.status-success {
    color: #2d6a4f;
}

.status-warning {
    color: #f4a261;
}

.status-error {
    color: #e76f51;
}

.status-info {
    color: #3498db;
}

.loading-indicator {
    display: inline-block;
    width: 12px;
    height: 12px;
    border: 2px solid #52b788;
    border-top-color: transparent;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-left: 0.5rem;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

@media (max-width: 768px) {
    .page-header h1 { font-size: 2rem; }
    .metrics-grid { grid-template-columns: 1fr; }
    .metric-card { padding: 1.5rem; }
    .chart-container { padding: 1.5rem; }
}
</style>
</head>
<body>

<nav class="navbar">
    <a href="/" class="brand"><i class="fas fa-leaf"></i> Smart Farm</a>
    <ul class="nav-links">
        <li><a href="/">Home</a></li>
        <li><a href="/crops">Crops</a></li>
        <li><a href="/analytics" class="active">Analytics</a></li>
        <li><a href="/settings">Settings</a></li>
    </ul>
</nav>

<div class="page-header">
    <h1><i class="fas fa-chart-line"></i> Analytics Dashboard</h1>
    <p>Real-time insights and intelligent monitoring for your smart farm</p>
</div>

<div class="container">

    <div class="metrics-grid">
        <div class="metric-card">
            <div class="metric-icon green"><i class="fas fa-tint"></i></div>
            <div class="metric-info">
                <h3 id="soilValue">--%</h3>
                <p>Soil Moisture</p>
                <button id="servoBtn">
                    <i class="fas fa-water"></i> Water Soil
                </button>
                <p id="servoStatus"></p>
            </div>
        </div>

        <div class="metric-card">
            <div class="metric-icon red"><i class="fas fa-temperature-high"></i></div>
            <div class="metric-info">
                <h3 id="tempValue">--°C</h3>
                <p>Temperature</p>
            </div>
        </div>

        <div class="metric-card">
            <div class="metric-icon blue"><i class="fas fa-cloud"></i></div>
            <div class="metric-info">
                <h3 id="humidityValue">--%</h3>
                <p>Humidity</p>
            </div>
        </div>

        <div class="metric-card">
            <div class="metric-icon orange"><i class="fas fa-cloud-rain"></i></div>
            <div class="metric-info">
                <h3 id="rainfallValue">--mm</h3>
                <p>Rainfall</p>
            </div>
        </div>

        <div class="metric-card">
            <div class="metric-icon orange"><i class="fas fa-cogs"></i></div>
            <div class="metric-info">
                <h3 id="motorPrediction">--</h3>
                <p>Motor Status</p>
            </div>
        </div>

        <div class="metric-card">
            <div class="metric-icon blue"><i class="fas fa-tint"></i></div>
            <div class="metric-info">
                <h3 id="waterLevel">--%</h3>
                <p>Water Tank Level</p>
            </div>
        </div>
    </div>

    <div class="chart-container">
        <div class="chart-header">
            <i class="fas fa-tint"></i>
            <h3>Soil Moisture Trends</h3>
        </div>
        <canvas id="soilChart"></canvas>
    </div>

    <div class="chart-container">
        <div class="chart-header">
            <i class="fas fa-thermometer-half"></i>
            <h3>Temperature & Humidity Analysis</h3>
        </div>
        <canvas id="tempHumChart"></canvas>
    </div>

    <div class="chart-container">
        <div class="chart-header">
            <i class="fas fa-cloud-rain"></i>
            <h3>Rainfall Monitoring</h3>
        </div>
        <canvas id="rainChart"></canvas>
    </div>
</div>

<script>
let soilData = [], tempData = [], humData = [], rainData = [], labels = [];

// Mock data for demonstration
let mockData = {
    soil_moisture: Math.floor(Math.random() * 100),
    water_level: Math.floor(Math.random() * 100),
    avg_temperature: Math.floor(Math.random() * 40) + 10,
    humidity: Math.floor(Math.random() * 100),
    rainfall: Math.floor(Math.random() * 50),
    motor_prediction: Math.random() > 0.5 ? "ON" : "OFF"
};

const chartOptions = {
    responsive: true,
    maintainAspectRatio: true,
    animation: {
        duration: 750,
        easing: 'easeInOutQuart'
    },
    interaction: {
        mode: 'index',
        intersect: false,
    },
    plugins: {
        legend: {
            display: true,
            position: 'top',
            labels: {
                usePointStyle: true,
                padding: 15,
                font: {
                    size: 12,
                    family: 'Inter',
                    weight: '500'
                }
            }
        },
        tooltip: {
            backgroundColor: 'rgba(0, 0, 0, 0.8)',
            padding: 12,
            borderRadius: 8,
            titleFont: {
                size: 14,
                family: 'Inter'
            },
            bodyFont: {
                size: 13,
                family: 'Inter'
            }
        }
    }
};

const soilCtx = document.getElementById('soilChart').getContext('2d');
const soilChart = new Chart(soilCtx, {
    type: 'line',
    data: {
        labels: labels,
        datasets: [{
            label: 'Soil Moisture (%)',
            data: soilData,
            borderColor: '#52b788',
            backgroundColor: 'rgba(82, 183, 136, 0.1)',
            tension: 0.4,
            fill: true,
            borderWidth: 3,
            pointRadius: 4,
            pointHoverRadius: 6,
            pointBackgroundColor: '#52b788',
            pointBorderColor: '#fff',
            pointBorderWidth: 2
        }]
    },
    options: {
        ...chartOptions,
        scales: {
            y: {
                min: 0,
                max: 100,
                grid: {
                    color: 'rgba(0, 0, 0, 0.05)'
                },
                ticks: {
                    font: {
                        family: 'Inter'
                    }
                }
            },
            x: {
                grid: {
                    display: false
                },
                ticks: {
                    font: {
                        family: 'Inter'
                    }
                }
            }
        }
    }
});

const tempHumCtx = document.getElementById('tempHumChart').getContext('2d');
const tempHumChart = new Chart(tempHumCtx, {
    type: 'line',
    data: {
        labels: labels,
        datasets: [
            {
                label: 'Temperature (°C)',
                data: tempData,
                borderColor: '#e76f51',
                backgroundColor: 'rgba(231, 111, 81, 0.1)',
                tension: 0.4,
                fill: true,
                borderWidth: 3,
                pointRadius: 4,
                pointHoverRadius: 6,
                pointBackgroundColor: '#e76f51',
                pointBorderColor: '#fff',
                pointBorderWidth: 2
            },
            {
                label: 'Humidity (%)',
                data: humData,
                borderColor: '#3498db',
                backgroundColor: 'rgba(52, 152, 219, 0.1)',
                tension: 0.4,
                fill: true,
                borderWidth: 3,
                pointRadius: 4,
                pointHoverRadius: 6,
                pointBackgroundColor: '#3498db',
                pointBorderColor: '#fff',
                pointBorderWidth: 2
            }
        ]
    },
    options: {
        ...chartOptions,
        scales: {
            y: {
                min: 0,
                max: 100,
                grid: {
                    color: 'rgba(0, 0, 0, 0.05)'
                },
                ticks: {
                    font: {
                        family: 'Inter'
                    }
                }
            },
            x: {
                grid: {
                    display: false
                },
                ticks: {
                    font: {
                        family: 'Inter'
                    }
                }
            }
        }
    }
});

const rainCtx = document.getElementById('rainChart').getContext('2d');
const rainChart = new Chart(rainCtx, {
    type: 'bar',
    data: {
        labels: labels,
        datasets: [{
            label: 'Rainfall (mm)',
            data: rainData,
            backgroundColor: 'rgba(244, 162, 97, 0.8)',
            borderColor: '#f4a261',
            borderWidth: 2,
            borderRadius: 8,
            hoverBackgroundColor: 'rgba(244, 162, 97, 1)'
        }]
    },
    options: {
        ...chartOptions,
        scales: {
            y: {
                beginAtZero: true,
                grid: {
                    color: 'rgba(0, 0, 0, 0.05)'
                },
                ticks: {
                    font: {
                        family: 'Inter'
                    }
                }
            },
            x: {
                grid: {
                    display: false
                },
                ticks: {
                    font: {
                        family: 'Inter'
                    }
                }
            }
        }
    }
});

// Get button element and add event listener
const servoBtn = document.getElementById("servoBtn");
servoBtn.addEventListener("click", controlServo);

async function fetchMetrics() {
    try {
        // Try to fetch real data first
        let soilJson, metrics;
        
        try {
            const soilResp = await fetch("/api/soil");
            soilJson = await soilResp.json();
        } catch (err) {
            console.warn('Using mock soil data');
            soilJson = {
                soil_moisture: mockData.soil_moisture,
                water_level: mockData.water_level
            };
        }
        
        try {
            const metricsResp = await fetch("/api/metrics");
            metrics = await metricsResp.json();
        } catch (err) {
            console.warn('Using mock metrics data');
            metrics = {
                avg_temperature: mockData.avg_temperature,
                humidity: mockData.humidity,
                rainfall: mockData.rainfall,
                motor_prediction: mockData.motor_prediction
            };
        }

        // Update display values
        animateValue('soilValue', soilJson.soil_moisture, '%');
        animateValue('waterLevel', soilJson.water_level, '%');
        animateValue('tempValue', metrics.avg_temperature, '°C');
        animateValue('humidityValue', metrics.humidity, '%');
        animateValue('rainfallValue', metrics.rainfall, 'mm');
        
        document.getElementById("motorPrediction").innerText = metrics.motor_prediction;

        // Update charts
        const now = new Date().toLocaleTimeString();
        labels.push(now);
        soilData.push(soilJson.soil_moisture);
        tempData.push(metrics.avg_temperature);
        humData.push(metrics.humidity);
        rainData.push(metrics.rainfall);

        if (labels.length > 20) {
            labels.shift();
            soilData.shift();
            tempData.shift();
            humData.shift();
            rainData.shift();
        }

        soilChart.update('active');
        tempHumChart.update('active');
        rainChart.update('active');
        
        // Update mock data for next call
        mockData = {
            soil_moisture: Math.max(0, Math.min(100, mockData.soil_moisture + (Math.random() * 10 - 5))),
            water_level: Math.max(0, Math.min(100, mockData.water_level + (Math.random() * 5 - 2.5))),
            avg_temperature: Math.max(10, Math.min(50, mockData.avg_temperature + (Math.random() * 4 - 2))),
            humidity: Math.max(0, Math.min(100, mockData.humidity + (Math.random() * 10 - 5))),
            rainfall: Math.max(0, mockData.rainfall + (Math.random() * 5 - 2)),
            motor_prediction: Math.random() > 0.7 ? (mockData.motor_prediction === "ON" ? "OFF" : "ON") : mockData.motor_prediction
        };
        
    } catch (err) {
        console.error('Error fetching metrics:', err);
    }
}

function animateValue(id, value, suffix = '') {
    const element = document.getElementById(id);
    const current = parseFloat(element.innerText) || 0;
    const target = parseFloat(value) || 0;
    
    // If values are the same, no need to animate
    if (Math.abs(current - target) < 0.1) {
        element.innerText = target.toFixed(1) + suffix;
        return;
    }
    
    const duration = 500;
    const steps = 20;
    const increment = (target - current) / steps;
    let step = 0;

    const timer = setInterval(() => {
        step++;
        const newValue = current + (increment * step);
        element.innerText = newValue.toFixed(1) + suffix;

        if (step >= steps) {
            clearInterval(timer);
            element.innerText = target.toFixed(1) + suffix;
        }
    }, duration / steps);
}

async function controlServo() {
    const btn = document.getElementById("servoBtn");
    const status = document.getElementById("servoStatus");
    
    console.log("Water Soil button clicked!"); // Debug log
    
    // Disable button and show loading state
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Watering...';
    status.innerHTML = '<span class="loading-indicator"></span> Activating irrigation...';
    status.className = 'status-info';

    try {
        // Try to call the real API
        let response;
        try {
            response = await fetch("/api/servo", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ action: "servo_down" })
            });
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
        } catch (err) {
            console.warn('Using mock servo control:', err.message);
            // Simulate API call with timeout
            await new Promise(resolve => setTimeout(resolve, 1000));
        }

        status.innerHTML = '<i class="fas fa-check-circle"></i> Irrigation active';
        status.className = 'status-success';

        // Simulate watering for 10 seconds
        setTimeout(async () => {
            status.innerHTML = '<span class="loading-indicator"></span> Stopping irrigation...';
            status.className = 'status-info';

            try {
                // Try to stop the real servo
                try {
                    response = await fetch("/api/servo", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ action: "servo_up" })
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                } catch (err) {
                    console.warn('Using mock servo stop:', err.message);
                    // Simulate API call with timeout
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }

                status.innerHTML = '<i class="fas fa-check-circle"></i> Irrigation complete';
                status.className = 'status-success';
                
                // Reset button
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-water"></i> Water Soil';
                
                // Update soil moisture after watering
                mockData.soil_moisture = Math.min(100, mockData.soil_moisture + 20);
                animateValue('soilValue', mockData.soil_moisture, '%');
                
                // Clear status after 3 seconds
                setTimeout(() => {
                    status.innerHTML = '';
                    status.className = '';
                }, 3000);
                
            } catch (err) {
                console.error('Error stopping irrigation:', err);
                status.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Error stopping irrigation';
                status.className = 'status-error';
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-water"></i> Water Soil';
            }
        }, 10000); // Reduced to 5 seconds for testing
        
    } catch (err) {
        console.error('Error starting irrigation:', err);
        status.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Connection error';
        status.className = 'status-error';
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-water"></i> Water Soil';
    }
}

// Initialize the dashboard
setInterval(fetchMetrics, 5000);
fetchMetrics();
</script>
</body>
</html>
